<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KMS Warriors CC | Sunday Match</title>
  <style>
    :root{
      --bg:#0b1020;
      --text:#eef2ff;
      --muted: rgba(238,242,255,.75);
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.14);
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --accent:#6ea8ff;
      --good:#26d07c;
      --bad:#ff5b5b;
      --warn:#ffcc66;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      min-height:100vh;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(110,168,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(38,208,124,.14), transparent 55%),
                  radial-gradient(900px 500px at 60% 100%, rgba(255,204,102,.12), transparent 50%),
                  var(--bg);
      overflow-x:hidden;
    }
    body::before{
      content:"KMS WARRIORS CC  •  KMS WARRIORS CC  •  KMS WARRIORS CC";
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 64px;
      font-weight: 900;
      letter-spacing: 6px;
      color: rgba(255,255,255,.05);
      transform: rotate(-18deg);
      white-space: nowrap;
      pointer-events:none;
      user-select:none;
    }
    .wrap{ max-width: 980px; margin: 26px auto; padding: 0 16px 40px; position:relative; z-index:1; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 14px; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:46px; height:46px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(110,168,255,.9), rgba(38,208,124,.75));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.18);
    }
    .logo svg{ width:28px; height:28px; opacity:.95; }
    .brand h1{ font-size: 16px; margin:0; line-height:1.2; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tabbtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 800;
      transition: .15s ease;
    }
    .tabbtn:hover{ background: rgba(255,255,255,.10); }
    .tabbtn.active{ background: rgba(110,168,255,.22); border-color: rgba(110,168,255,.45); }

    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap: 14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .card h2{ margin:0 0 10px; font-size: 16px; }
    .sub{ color: var(--muted); font-size: 12px; margin-top:-6px; margin-bottom: 12px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:12px 0 6px; }
    input[type="text"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline: none;
    }

    .q{ margin:14px 0 10px; font-weight:900; font-size:15px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 12px;
      font-weight: 900;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.12); }
    .btn.good{ background: rgba(38,208,124,.20); border-color: rgba(38,208,124,.45); }
    .btn.bad{ background: rgba(255,91,91,.18); border-color: rgba(255,91,91,.45); }
    .btn.accent{ background: rgba(110,168,255,.24); border-color: rgba(110,168,255,.45); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      font-size: 12px; color: var(--muted);
    }

    .msg{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      line-height:1.35;
    }
    .msg.good{ border-color: rgba(38,208,124,.35); background: rgba(38,208,124,.10); }
    .msg.bad{ border-color: rgba(255,91,91,.35); background: rgba(255,91,91,.10); }
    .msg.warn{ border-color: rgba(255,204,102,.40); background: rgba(255,204,102,.10); }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    th, td{ text-align:left; padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,.08); font-size: 13px; }
    th{ font-size: 12px; color: var(--muted); background: rgba(255,255,255,.04); }
    tr:last-child td{ border-bottom: 0; }

    .footerNote{ margin-top: 12px; color: rgba(238,242,255,.60); font-size: 12px; line-height:1.35; }

    /* Modal */
    .modalOverlay{
      position: fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 16px; z-index: 9999;
    }
    .modal{
      width: min(560px, 100%);
      background: rgba(20,24,40,.92);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 18px;
      box-shadow: 0 28px 80px rgba(0,0,0,.6);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .modalHeader{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .modalHeader h3{ margin:0; font-size:16px; }
    .xbtn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      width:40px; height:40px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
    }
    .appGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 520px){ .appGrid{ grid-template-columns: 1fr; } }

    .code{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: rgba(238,242,255,.85);
      display:inline-block;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="KMS Warriors CC Logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 18l6-6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M11 7l6 6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M14 6c1.5-1.5 4-1.5 5.5 0s1.5 4 0 5.5L12 19c-1.5 1.5-4 1.5-5.5 0s-1.5-4 0-5.5L14 6z"
                  stroke="white" stroke-width="2" stroke-linejoin="round" opacity=".9"/>
          </svg>
        </div>
        <div>
          <h1>KMS Warriors CC</h1>
          <p>Sunday Match • Availability + ₹100 Fee</p>
        </div>
      </div>

      <div class="tabs">
        <button class="tabbtn active" id="tabVote" onclick="showTab('vote')">Vote</button>
        <button class="tabbtn" id="tabResults" onclick="showTab('results')">Results</button>
      </div>
    </div>

    <!-- VOTE -->
    <div id="viewVote" class="grid">
      <div class="card">
        <h2>Availability</h2>
        <div class="sub">Click Yes → choose a UPI app → pay → confirm UTR. Until then, status stays Pending.</div>

        <label>Your Name</label>
        <input type="text" id="name" placeholder="Eg: Muthu" maxlength="40" />

        <div class="q">Q: Available for Sunday Match?</div>
        <div class="row">
          <button class="btn good" id="btnYes" onclick="onYes()">Yes (Pay ₹100)</button>
          <button class="btn bad" id="btnNo" onclick="onNo()">No</button>
          <span class="pill" id="statusPill">Status: Not submitted</span>
        </div>

        <div id="voteMessage" class="msg" style="display:none;"></div>

        <div id="utrBox" class="msg warn" style="display:none;">
          <b>Confirm Payment</b><br>
          After paying ₹100, enter UTR / Transaction ID:
          <label style="margin-top:10px;">UTR / Transaction ID</label>
          <input type="text" id="utr" placeholder="Eg: 123456789012" maxlength="40" />
          <div class="row" style="margin-top:10px;">
            <button class="btn accent" onclick="confirmPaid()">Mark as Paid</button>
          </div>
          <div class="footerNote">
            (Web pages can’t verify UPI payment automatically. UTR is required to mark “YES = Paid”.)
          </div>
        </div>

        <div class="footerNote">
          Tip: On Android, the generic <b>upi://pay</b> link usually shows an app chooser. If you have only one UPI app, it opens directly.
        </div>
      </div>

      <div class="card">
        <h2>Payment Details</h2>
        <div class="sub">Use these details in any UPI app.</div>
        <div class="msg">
          Amount: <b>₹100</b><br>
          Pay to (UPI ID): <span class="code">mutharasu93@okaxis</span><br>
          Note: <b>Sunday Match Fee</b>
          <div class="row" style="margin-top:10px;">
            <button class="btn accent" onclick="copyUPI()">Copy UPI ID</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="viewResults" class="card" style="display:none;">
      <h2>Results</h2>
      <div class="sub">Shows status as Pending until payment is confirmed (UTR).</div>

      <div class="row">
        <span class="pill" id="kpiTotal">Total: 0</span>
        <span class="pill" id="kpiPaidYes">YES (Paid): 0</span>
        <span class="pill" id="kpiPending">Pending: 0</span>
        <span class="pill" id="kpiNo">NO: 0</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Availability</th>
            <th>Payment</th>
            <th>UTR</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div class="footerNote">
        Note: This stores results on the same device/browser. If you want a single central results page for everyone, you’ll need a backend (Google Sheets/Firebase).
      </div>
    </div>
  </div>

  <!-- UPI APP CHOOSER MODAL -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Select UPI app">
      <div class="modalHeader">
        <div>
          <h3>Select a UPI App</h3>
          <div class="sub" style="margin:6px 0 0;">
            Tap any app below — your phone will open the UPI flow (or show app chooser).
          </div>
        </div>
        <button class="xbtn" onclick="closeModal()">✕</button>
      </div>

      <div class="msg warn" style="margin-top:12px;">
        Pay <b>₹100</b> to <b>mutharasu93@okaxis</b><br>
        Then come back and enter the <b>UTR</b> to mark your availability as <b>YES</b>.
      </div>

      <div class="appGrid">
        <!-- These buttons intentionally use the SAME UPI link.
             Because from a web page we cannot reliably detect installed apps.
             On most Android phones, tapping will show the app chooser if multiple apps exist. -->
        <button class="btn accent" onclick="openUpi()">Google Pay</button>
        <button class="btn accent" onclick="openUpi()">PhonePe</button>
        <button class="btn accent" onclick="openUpi()">Paytm</button>
        <button class="btn accent" onclick="openUpi()">BHIM</button>
        <button class="btn" onclick="openUpi()">Other UPI App</button>
        <button class="btn" onclick="copyUpiLink()">Copy UPI Link</button>
      </div>

      <div class="footerNote" style="margin-top:12px;">
        If it still opens WhatsApp payment, use “Other UPI App” (same link) or open your preferred UPI app manually and pay using the UPI ID.
      </div>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  const STORAGE_KEY = "kms_warriors_sunday_poll_v3";
  const DEVICE_KEY  = "kms_warriors_device_id_v1";

  const UPI = {
    pa: "mutharasu93@okaxis",
    pn: "KMS Warriors CC",
    am: "100",
    cu: "INR",
    tn: "Sunday Match Fee"
  };

  // ===== Helpers =====
  function nowISO(){ return new Date().toISOString(); }
  function fmt(iso){ try { return new Date(iso).toLocaleString(); } catch(e){ return iso; } }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[s]));
  }

  function getDeviceId(){
    let id = localStorage.getItem(DEVICE_KEY);
    if(!id){
      id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      localStorage.setItem(DEVICE_KEY, id);
    }
    return id;
  }

  function getData(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { entries: [] }; }
    catch(e){ return { entries: [] }; }
  }
  function setData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

  function findMyEntry(){
    const did = getDeviceId();
    const data = getData();
    return data.entries.find(e => e.deviceId === did) || null;
  }

  function upsertMyEntry(patch){
    const did = getDeviceId();
    const data = getData();
    const idx = data.entries.findIndex(e => e.deviceId === did);
    if(idx >= 0){
      data.entries[idx] = { ...data.entries[idx], ...patch, updatedAt: nowISO() };
    } else {
      data.entries.push({
        deviceId: did,
        name: patch.name || "",
        availability: patch.availability || "NO",
        paymentStatus: patch.paymentStatus || "NA", // PAID | PENDING | NA
        utr: patch.utr || "",
        createdAt: nowISO(),
        updatedAt: nowISO()
      });
    }
    setData(data);
  }

  function setStatus(text){
    document.getElementById("statusPill").textContent = "Status: " + text;
  }

  function showMsg(text, kind){
    const el = document.getElementById("voteMessage");
    el.style.display = "block";
    el.className = "msg" + (kind ? (" " + kind) : "");
    el.innerHTML = text;
  }

  function showTab(which){
    const isVote = which === "vote";
    document.getElementById("viewVote").style.display = isVote ? "grid" : "none";
    document.getElementById("viewResults").style.display = isVote ? "none" : "block";
    document.getElementById("tabVote").classList.toggle("active", isVote);
    document.getElementById("tabResults").classList.toggle("active", !isVote);
    if(!isVote) renderResults();
  }

  // ===== UPI link =====
  function buildUpiUrl(){
    const q = new URLSearchParams({ pa: UPI.pa, pn: UPI.pn, am: UPI.am, cu: UPI.cu, tn: UPI.tn });
    return "upi://pay?" + q.toString();
  }
  function openUpi(){
    // Most reliable from web: open generic UPI link.
    // Android will usually show an app chooser if multiple UPI apps are installed.
    window.location.href = buildUpiUrl();
  }
  async function copyUPI(){
    try{
      await navigator.clipboard.writeText(UPI.pa);
      showMsg("Copied UPI ID ✅", "good");
    }catch(e){
      showMsg("Copy failed. Please copy manually: <b>" + escapeHtml(UPI.pa) + "</b>", "warn");
    }
  }
  async function copyUpiLink(){
    try{
      await navigator.clipboard.writeText(buildUpiUrl());
      showMsg("Copied UPI payment link ✅", "good");
    }catch(e){
      showMsg("Copy failed. Please try again.", "warn");
    }
  }

  // ===== Modal =====
  function openModal(){ document.getElementById("modalOverlay").style.display = "flex"; }
  function closeModal(){ document.getElementById("modalOverlay").style.display = "none"; }

  // ===== Actions =====
  function getNameOrWarn(){
    const name = document.getElementById("name").value.trim();
    if(!name){
      showMsg("Please enter your name.", "warn");
      return null;
    }
    return name;
  }

  function onNo(){
    const name = getNameOrWarn(); if(!name) return;

    // If already YES pending/paid, block switching (optional). Here: allow only if not paid.
    const mine = findMyEntry();
    if(mine && mine.availability === "YES" && mine.paymentStatus === "PAID"){
      showMsg("You already confirmed <b>YES (Paid)</b>. Cannot change to NO.", "warn");
      return;
    }

    upsertMyEntry({ name, availability: "NO", paymentStatus: "NA", utr: "" });
    document.getElementById("utrBox").style.display = "none";
    setStatus("Submitted (NO)");
    showMsg("You saved your 100 Rupees ✅", "bad");
    lockName();
  }

  function onYes(){
    const name = getNameOrWarn(); if(!name) return;

    // Create/Update as YES but PENDING until UTR confirmed
    const mine = findMyEntry();
    if(mine && mine.availability === "YES" && mine.paymentStatus === "PAID"){
      setStatus("YES (Paid)");
      showMsg("Already recorded as <b>YES (Paid)</b> ✅", "good");
      lockName();
      return;
    }

    upsertMyEntry({ name, availability: "YES", paymentStatus: "PENDING" });
    setStatus("YES (Pending Payment)");
    showMsg("Payment required: choose a UPI app, pay ₹100, then enter UTR to confirm.", "warn");
    document.getElementById("utrBox").style.display = "block";
    openModal(); // show app list immediately
    lockName();
  }

  function confirmPaid(){
    const mine = findMyEntry();
    if(!mine || mine.availability !== "YES"){
      showMsg("Please choose <b>YES</b> first.", "warn");
      return;
    }
    const utr = document.getElementById("utr").value.trim();
    if(!utr || utr.length < 6){
      showMsg("Enter a valid UTR / Transaction ID (min 6 chars).", "warn");
      return;
    }
    upsertMyEntry({ availability: "YES", paymentStatus: "PAID", utr });
    setStatus("YES (Paid)");
    showMsg("Payment confirmed ✅ Availability marked as <b>YES</b>.", "good");
    closeModal();
  }

  function lockName(){
    // Prevent changing identity mid-way. You can remove this if you want.
    document.getElementById("name").disabled = true;
  }

  // ===== Results =====
  function renderResults(){
    const data = getData();
    const entries = data.entries.slice().sort((a,b)=> (a.updatedAt < b.updatedAt ? 1 : -1));

    const yesPaid = entries.filter(e => e.availability === "YES" && e.paymentStatus === "PAID").length;
    const yesPending = entries.filter(e => e.availability === "YES" && e.paymentStatus === "PENDING").length;
    const no = entries.filter(e => e.availability === "NO").length;

    document.getElementById("kpiTotal").textContent = `Total: ${entries.length}`;
    document.getElementById("kpiPaidYes").textContent = `YES (Paid): ${yesPaid}`;
    document.getElementById("kpiPending").textContent = `Pending: ${yesPending}`;
    document.getElementById("kpiNo").textContent = `NO: ${no}`;

    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";
    entries.forEach((e, idx)=>{
      const avail = e.availability === "YES"
        ? (e.paymentStatus === "PAID" ? "YES" : "YES")
        : "NO";
      const pay = e.availability === "YES"
        ? (e.paymentStatus === "PAID" ? "PAID" : "PENDING")
        : "NA";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td><b>${escapeHtml(e.name || "-")}</b></td>
        <td>${avail}</td>
        <td>${pay}</td>
        <td>${e.utr ? escapeHtml(e.utr) : "-"}</td>
        <td>${fmt(e.updatedAt)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===== Init: restore state for same device =====
  (function init(){
    const mine = findMyEntry();
    if(mine){
      document.getElementById("name").value = mine.name || "";
      lockName();

      if(mine.availability === "NO"){
        setStatus("Submitted (NO)");
        showMsg("Already submitted as <b>NO</b>.", "bad");
        document.getElementById("utrBox").style.display = "none";
      } else if(mine.availability === "YES" && mine.paymentStatus === "PENDING"){
        setStatus("YES (Pending Payment)");
        showMsg("You have a <b>pending</b> YES. Please pay and enter UTR to confirm.", "warn");
        document.getElementById("utrBox").style.display = "block";
      } else if(mine.availability === "YES" && mine.paymentStatus === "PAID"){
        setStatus("YES (Paid)");
        showMsg("Already confirmed as <b>YES (Paid)</b> ✅", "good");
        document.getElementById("utrBox").style.display = "none";
      }
    }
  })();
</script>
</body>
</html>
